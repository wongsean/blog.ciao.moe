<!DOCTYPE html>
<html lang=zh>
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="写 Ruby on Rails 已有一年有余，随着渐渐开始走进 Rails 的神秘魔法的根源，些许不优雅之处和槽点也可窥见一斑，Rails 作为 Ruby 圈不可避免的重量级框架，似乎在理念上偶尔也与 Ruby 貌合神离。为了几年这一年多里踩过的坑（或是文档读的不够仔细），也为了给自己一个总结所有所见所想所调查的机会，写下这一个系列，从常量查询说起。 当然，个人水平有限，又盲目自信，内容可能错误多">
<meta property="og:type" content="article">
<meta property="og:title" content="Ruby Constant Lookup">
<meta property="og:url" content="https://blog.ciao.moe/2017/06/25/ruby-constant-lookup/index.html">
<meta property="og:site_name" content="Ciao.moe">
<meta property="og:description" content="写 Ruby on Rails 已有一年有余，随着渐渐开始走进 Rails 的神秘魔法的根源，些许不优雅之处和槽点也可窥见一斑，Rails 作为 Ruby 圈不可避免的重量级框架，似乎在理念上偶尔也与 Ruby 貌合神离。为了几年这一年多里踩过的坑（或是文档读的不够仔细），也为了给自己一个总结所有所见所想所调查的机会，写下这一个系列，从常量查询说起。 当然，个人水平有限，又盲目自信，内容可能错误多">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-09-24T09:13:36.150Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ruby Constant Lookup">
<meta name="twitter:description" content="写 Ruby on Rails 已有一年有余，随着渐渐开始走进 Rails 的神秘魔法的根源，些许不优雅之处和槽点也可窥见一斑，Rails 作为 Ruby 圈不可避免的重量级框架，似乎在理念上偶尔也与 Ruby 貌合神离。为了几年这一年多里踩过的坑（或是文档读的不够仔细），也为了给自己一个总结所有所见所想所调查的机会，写下这一个系列，从常量查询说起。 当然，个人水平有限，又盲目自信，内容可能错误多">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Ruby Constant Lookup</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/wongsean">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2018/03/03/time-datetime-timewithzone/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://blog.ciao.moe/2017/06/25/ruby-constant-lookup/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://blog.ciao.moe/2017/06/25/ruby-constant-lookup/&text=Ruby Constant Lookup"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://blog.ciao.moe/2017/06/25/ruby-constant-lookup/&title=Ruby Constant Lookup"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://blog.ciao.moe/2017/06/25/ruby-constant-lookup/&is_video=false&description=Ruby Constant Lookup"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Ruby Constant Lookup&body=Check out this article: https://blog.ciao.moe/2017/06/25/ruby-constant-lookup/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://blog.ciao.moe/2017/06/25/ruby-constant-lookup/&title=Ruby Constant Lookup"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://blog.ciao.moe/2017/06/25/ruby-constant-lookup/&title=Ruby Constant Lookup"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://blog.ciao.moe/2017/06/25/ruby-constant-lookup/&title=Ruby Constant Lookup"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://blog.ciao.moe/2017/06/25/ruby-constant-lookup/&title=Ruby Constant Lookup"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://blog.ciao.moe/2017/06/25/ruby-constant-lookup/&name=Ruby Constant Lookup&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#constant-definitions"><span class="toc-number">1.</span> <span class="toc-text">Constant Definitions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#module-nesting"><span class="toc-number">2.</span> <span class="toc-text">Module.nesting</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ancestors"><span class="toc-number">3.</span> <span class="toc-text">Ancestors</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#toplevel-constants"><span class="toc-number">4.</span> <span class="toc-text">Toplevel Constants?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#constants-lookup-the-ugly"><span class="toc-number">5.</span> <span class="toc-text">Constants Lookup, The Ugly</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Ruby Constant Lookup
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Ciao.moe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2017-06-25T09:57:07.000Z" itemprop="datePublished">2017-06-25</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/tech/">tech</a>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>写 Ruby on Rails 已有一年有余，随着渐渐开始走进 Rails 的神秘魔法的根源，些许不优雅之处和槽点也可窥见一斑，Rails 作为 Ruby 圈不可避免的重量级框架，似乎在理念上偶尔也与 Ruby 貌合神离。为了几年这一年多里踩过的坑（或是文档读的不够仔细），也为了给自己一个总结所有所见所想所调查的机会，写下这一个系列，从常量查询说起。</p>
<p>当然，个人水平有限，又盲目自信，内容可能错误多多，还望兼听则明，也欢迎随时指正，就酱！</p>
<h2 id="constant-definitions">Constant Definitions</h2>
<p>想要了解 Ruby 查询常量的过程，我们首先需要了解 Ruby 是如何定义以及存储常量的。</p>
<p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># module is a constant</span></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Namespace</span></span></span><br><span class="line">  <span class="comment"># class is also a constant</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Something</span></span></span><br><span class="line">    <span class="comment"># still a constant</span></span><br><span class="line">    SOME_VALUE = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>Ruby 中同样存在词法作用域的概念，与大多数语言不同的是，<code>module</code> 与 <code>class</code> 关键字会打开一个全新的作用域。上面代码中常量 <code>SOME_VALUE</code> 定义于 class <code>Something</code> 作用域中，那么常量实际上被储存在哪里呢？</p>
<p>在 Ruby MRI 中，每一个 Ruby class 会对应一个 RCLASS 的 C 结构体，而在这个作用域中定义的常量都会记录在这个 C 结构体中，在 irb 中我们可以通过 <code>Namespace::Something.constants(false)</code><sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup> 来查看定义在 <code>Something</code> 中的常量。</p>
<p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">irb(main):008:0&gt;</span> Namespace::Something.constants</span><br><span class="line">=&gt; [<span class="symbol">:SOME_VALUE</span>]</span><br></pre></td></tr></table></figure></p>
<p>自然而然的，class <code>Something</code> 是定义在 module <code>Namespace</code> 所打开的作用域中的常量。</p>
<p>继续思考下去，问题就变成了，顶级作用域中的 module <code>Namespace</code> 又是被存储在哪里的？这里我们简明扼要的说，他们存储在 <code>Object</code> 内的常量表内。通过 <code>Object.constants(false)</code> 你可以获取到你定义的所有顶层常量。</p>
<h2 id="module-nesting">Module.nesting</h2>
<p>上文提到过，每当 <code>module</code> 或 <code>class</code> 关键字出现的时候，Ruby 会打开一个全新的作用域，形成多个作用域的嵌套。</p>
<p>在 Ruby 的 C 实现中，结构体 <code>rb_cref_t</code><sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup> 用来表示当前作用域:</p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">rb_cref_struct</span> &#123;</span></span><br><span class="line">    VALUE flags;</span><br><span class="line">    <span class="keyword">const</span> VALUE refinements;</span><br><span class="line">    <span class="keyword">const</span> VALUE klass;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_cref_struct</span> * <span class="title">const</span> <span class="title">next</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">rb_scope_visibility_t</span> scope_visi;</span><br><span class="line">&#125; <span class="keyword">rb_cref_t</span>;</span><br><span class="line">``` </span><br><span class="line">其中，属性 klass 表示当前作用域所在 <span class="class"><span class="keyword">class</span>/<span class="title">module</span>，<span class="title">next</span> 则指向代表上一层作用域的 <span class="title">cref</span> 结构体。这一条通过 <span class="title">next</span> 指针而产生的链表，很好的表示了从当前作用域到顶级作用域的层级关系。在 <span class="title">irb</span> 中我们可以通过 `<span class="title">Module</span>.<span class="title">nesting</span>` 来查看该链表的 <span class="title">klass</span> 值映射。</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">```<span class="title">ruby</span></span></span><br><span class="line"><span class="class"><span class="title">module</span> <span class="title">A</span></span></span><br><span class="line"><span class="class">  <span class="title">class</span> <span class="title">B</span></span></span><br><span class="line"><span class="class">    <span class="title">class</span> <span class="title">C</span></span></span><br><span class="line"><span class="class">      <span class="title">p</span> <span class="title">Module</span>.<span class="title">nesting</span> # =&gt; [<span class="title">A</span>:</span>:B::C, A::B, A]</span><br><span class="line">      </span><br><span class="line">      p B == ::A::B # =&gt; <span class="literal">true</span></span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>那么当我们尝试在上述代码中访问常量 <code>B</code> 时，Ruby 会按照 <code>Module.nesting</code> 所呈现的顺序，先查询 <code>A::B::C</code> 下的常量表，发现找不到，再查找 <code>A::B</code> 下的常量表，同样没有。最后，在 <code>A</code> 的常量表中找到了 <code>B</code> 的定义。</p>
<p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">A</span>;</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">A::B</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">    p Module.nesting <span class="comment"># =&gt; [A::B::C, A::B]</span></span><br><span class="line">    </span><br><span class="line">    p B == <span class="symbol">:</span><span class="symbol">:A</span><span class="symbol">:</span><span class="symbol">:B</span> <span class="comment"># =&gt; ???</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>可以猜测到以上代码的结果了么？以上代码会抛出异常 <code>NameError: uninitialized constant A::B::C::B</code></p>
<h2 id="ancestors">Ancestors</h2>
<p>仅通过查找作用域链并不能满足所有需求，我们也希望在子类中访问超类中的常量</p>
<p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span></span></span><br><span class="line">  CONST = <span class="string">'constant in base'</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sub</span> &lt; Base</span></span><br><span class="line">  p CONST <span class="comment"># =&gt; constant in base</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">p Sub::CONST <span class="comment"># =&gt; constant in base</span></span><br></pre></td></tr></table></figure></p>
<p>熟悉面向对象便不难猜到，Ruby 也会通过继承树查询常量。Ruby 会通过当前作用域类<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>的继承树，我们可以通过 <code>Sub.ancestors</code> 来了解继承树的结构。</p>
<p>这同时就产生了一个问题，当父作用域与超类中同时存在目标常量的定义，Ruby 会如何选择？尝试运行以下代码。</p>
<p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span></span></span><br><span class="line">  CONST = <span class="string">'constant in base'</span></span><br><span class="line">  CONST_1 = <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Namespace</span></span></span><br><span class="line">  CONST = <span class="string">'constant in namespace'</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Sub</span> &lt; Base</span></span><br><span class="line">    p Module.constants</span><br><span class="line">    p CONST <span class="comment"># =&gt; 'constant in namespace'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  p Sub::CONST  <span class="comment"># =&gt; 'constant in base'</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>第一句 <code>p CONST</code> 的输出是 'constant in namespace'，这时我们这时可以确定 Ruby 会先尝试在作用域链中查找常量，然后才是继承树。
第二句 <code>p Namespace::Sub::CONST</code> 看起来和第一句很类似，但输出结果却并不相同，事实上在运行第二句的时候，我们会先查找常量 <code>Sub</code>，然后再在 <code>Sub</code> 下查找常量 <code>CONST</code>，此时 Ruby 不再会在考虑作用域链，而是直接进入第二步，查找 <code>Sub</code> 的继承树。除此之外，连个这对 <code>CONST</code> 的查找仍然有一些不同，这会在之后的内容里详细说明。</p>
<h2 id="toplevel-constants">Toplevel Constants?</h2>
<p>等等？我们似乎忘了什么？通过 <code>Module.nesting</code> 似乎无法查询到顶级作用域的常量，那么定层作用域的常量是如何查询的？Ruby 是否对顶层常量有特殊的处理？</p>
<p>是，也不是。
说出来你可能不信，Ruby 是通过继承树找到这些顶层常量的。如果你还记得，Ruby 将顶层常量保存在 <code>Object</code> 中。</p>
<p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line">  p Math::PI</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>因此在上述代码中，当我在 <code>MyClass</code> 的类作用域中尝试访问顶层常量 <code>Math</code> 时，Ruby 是通过 <code>MyClass</code> 的继承树查找到 <code>Object</code> 内存储的顶层常量的。
看来问题解决了！，我们并不需要引入一个新的规则来解决顶层常量查找问题了，可喜可贺！</p>
<p>问题真的解决了吗？</p>
<p>如果你十分熟悉 Ruby 的内部的继承树，你可能会注意到 <code>Object</code> 并不是继承树的顶端，这还不是最要紧的，当我们定义时常被我们作为命名空间的 module 的时候，其继承树中甚至可能只有这个 module 存在！</p>
<p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Namespace</span>;</span> <span class="keyword">end</span></span><br><span class="line">p Namespace.ancestors <span class="comment"># =&gt; [Namespace]</span></span><br></pre></td></tr></table></figure></p>
<p>这不太妙！我是必然是需要在这些 module 作用域中访问顶层常量的。于是 Ruby 在搜索继承树的逻辑后加上，如果这是个 module，我们就从 <code>Object</code> 的继承树中再搜索一遍！这下真的皆大欢喜了，至于那些在继承树中处于 <code>Object</code> 之上位置的类，例如 <code>Kernel, BasicObject</code> 我们也管不了那么多了（事实上更可能是故意为之）。
事实上这也是 <code>BasicObject</code> 类作用域时常被作为一个特殊的，干净的作用域使用的原因。</p>
<p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasicObject</span></span></span><br><span class="line">  p String <span class="comment"># =&gt; NameError: uninitialized constant BasicObject::String</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<h2 id="constants-lookup-the-ugly">Constants Lookup, The Ugly</h2>
<p>让我们来看一下以下代码：</p>
<p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hash</span></span></span><br><span class="line">  p String == Hash::String</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>在一个类作用域（这里是 <code>Hash</code>）中可以访问顶层常量（这里是 <code>String</code>）显然正是我们之前期望得到的结果。但 <code>Hash::String</code> 是什么？显然并不存在一个这样的类。于是，当我们满心期望着这段代码抛出异常时，你可能会惊讶于得到以下结果：</p>
<p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(irb)<span class="symbol">:</span><span class="number">21</span>: <span class="symbol">warning:</span> toplevel constant String referenced by Hash::String</span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure></p>
<p>什么？这怎么可能？
原因其实很简单，两种对 <code>String</code> 常量的查询过程，在搜索继承树这一步骤是极其极其相似的，他们都尝试在 <code>Hash</code> 内查找常量 <code>String</code> 的定义，查找不到后都会沿继承树向上搜索，显然也都会搜索到 <code>Object</code>。</p>
<p>这会出问题吗？
事实是会的，尤其在 Rails autoloading 的情况下，由于 Rails autoloading 依赖于 <code>const_missing</code> 的实现，当一个同名的顶层常量已经率先加载的情况下，程序可能将你的常量错误的引用到该顶层常量上，仅仅给出一条 warning，淹没在无尽的 log 中，下面的代码摘自 <a href="http://guides.rubyonrails.org/autoloading_and_reloading_constants.html#when-constants-aren-t-missed" target="_blank" rel="noopener">Rails 官方文档</a><sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup></p>
<p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/models/hotel.rb</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hotel</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># app/models/image.rb</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Image</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># app/models/hotel/image.rb</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hotel</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Image</span> &lt; Image</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ bin/rails r <span class="string">'Image; p Hotel::Image'</span> 2&gt;/dev/null</span><br><span class="line">Image <span class="comment"># NOT Hotel::Image!</span></span><br></pre></td></tr></table></figure></p>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>通常有两个 <code>constants</code> 方法，这里特指定义在 <code>Module</code> 中的<strong>实例</strong>方法。当参数 <code>inherit = false</code> 时，该方法将仅列举存储在类中常量表的常量名。 <a href="#fnref1" class="footnote-backref">↩</a></p>
</li>
<li id="fn2" class="footnote-item"><p>基于 Ruby 2.4 的实现，在 Ruby 2.3 之前是 <code>NODE</code> 结构体 <a href="#fnref2" class="footnote-backref">↩</a></p>
</li>
<li id="fn3" class="footnote-item"><p>需要注意的是，继承树的起点并不是 <code>self.class</code> 而是当前作用域类 <a href="#fnref3" class="footnote-backref">↩</a></p>
</li>
<li id="fn4" class="footnote-item"><p>值得庆幸的是 Ruby 2.5.0 中，终于将 warning 修改为直接抛出异常 <a href="#fnref4" class="footnote-backref">↩</a></p>
</li>
</ol>
</section>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/wongsean">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#constant-definitions"><span class="toc-number">1.</span> <span class="toc-text">Constant Definitions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#module-nesting"><span class="toc-number">2.</span> <span class="toc-text">Module.nesting</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ancestors"><span class="toc-number">3.</span> <span class="toc-text">Ancestors</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#toplevel-constants"><span class="toc-number">4.</span> <span class="toc-text">Toplevel Constants?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#constants-lookup-the-ugly"><span class="toc-number">5.</span> <span class="toc-text">Constants Lookup, The Ugly</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://blog.ciao.moe/2017/06/25/ruby-constant-lookup/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://blog.ciao.moe/2017/06/25/ruby-constant-lookup/&text=Ruby Constant Lookup"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://blog.ciao.moe/2017/06/25/ruby-constant-lookup/&title=Ruby Constant Lookup"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://blog.ciao.moe/2017/06/25/ruby-constant-lookup/&is_video=false&description=Ruby Constant Lookup"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Ruby Constant Lookup&body=Check out this article: https://blog.ciao.moe/2017/06/25/ruby-constant-lookup/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://blog.ciao.moe/2017/06/25/ruby-constant-lookup/&title=Ruby Constant Lookup"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://blog.ciao.moe/2017/06/25/ruby-constant-lookup/&title=Ruby Constant Lookup"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://blog.ciao.moe/2017/06/25/ruby-constant-lookup/&title=Ruby Constant Lookup"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://blog.ciao.moe/2017/06/25/ruby-constant-lookup/&title=Ruby Constant Lookup"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://blog.ciao.moe/2017/06/25/ruby-constant-lookup/&name=Ruby Constant Lookup&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 Sean Wong
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/wongsean">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<!-- clipboard -->

  <script src="/lib/clipboard/clipboard.min.js"></script>
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code pre").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      target: function(trigger) {
        return trigger.nextElementSibling;
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>

<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
